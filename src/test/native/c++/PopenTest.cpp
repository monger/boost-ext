// Use this include instead of "boost/test/unit_test.hpp"
#include "boost-ext/test/unit_test.hpp"

#include "boost/iostreams/stream.hpp"
#include "boost-ext/popen_source.hpp"

// Set up our suite fixture
struct PopenTestFixture {
    PopenTestFixture() { }
    ~PopenTestFixture() { }
};

// Register the fixture with our suite - just like "regular" BOOST_AUTO_TEST_CASE
BOOST_FIXTURE_TEST_SUITE(PopenTestSuite, PopenTestFixture);

// Just do the same to define a single test case
BOOST_AUTO_TEST_CASE(testPopen) {
    boost_ext::iostreams::popen_source                              pSource("ls -l");
    boost::iostreams::stream<boost_ext::iostreams::popen_source>    pStream(pSource);
    BOOST_CHECK(pSource.is_open());

    std::string line;
    int numLines = 0;
    while (std::getline(pStream, line)) {
        BOOST_MESSAGE(" READ: " + line);
        numLines++;
    }
    BOOST_CHECK_GT(numLines, 0);
    BOOST_CHECK_EQUAL(pSource.return_status(), 0);
}

BOOST_AUTO_TEST_CASE(testPopenFail) {
    boost_ext::iostreams::popen_source                              pSource("invalid_cmd 2>/dev/null");
    boost::iostreams::stream<boost_ext::iostreams::popen_source>    pStream(pSource);
    BOOST_CHECK(pSource.is_open());

    std::string line;
    int numLines = 0;
    while (std::getline(pStream, line)) { numLines++; }
    BOOST_CHECK_EQUAL(numLines, 0);
    BOOST_CHECK_NE(pSource.return_status(), 0);
}

// Remember to end your suite
BOOST_AUTO_TEST_SUITE_END ();
